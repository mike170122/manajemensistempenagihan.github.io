<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <meta name="msapplication-navbutton-color" content="#2563eb">
    <meta name="apple-mobile-web-app-title" content="Sistem Tagihan">
    <title>Sistem Pengelolaan Tagihan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
        }
        
        /* Android Fullscreen Styles */
        html, body {
            height: 100%;
            height: 100vh;
            height: 100dvh; /* Dynamic viewport height for modern browsers */
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }
        
        /* PWA-like fullscreen for Android */
        @media screen and (max-width: 768px) {
            html {
                height: -webkit-fill-available;
            }
            
            body {
                min-height: 100vh;
                min-height: -webkit-fill-available;
                position: relative;
                overflow: auto;
            }
            
            /* Hide address bar on Android */
            .mobile-fullscreen {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100vw;
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
            }
            
            /* Ensure content fills entire screen */
            #mainApp {
                height: 100vh;
                height: 100dvh;
                max-height: 100vh;
                max-height: 100dvh;
            }
            
            /* Status bar overlay for Android */
            .status-bar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: env(safe-area-inset-top, 24px);
                background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
                z-index: 1000;
                pointer-events: none;
            }
            
            /* Adjust content for status bar */
            .mobile-content {
                padding-top: env(safe-area-inset-top, 24px);
                padding-bottom: env(safe-area-inset-bottom, 0px);
                height: calc(100vh - env(safe-area-inset-top, 24px) - env(safe-area-inset-bottom, 0px));
                height: calc(100dvh - env(safe-area-inset-top, 24px) - env(safe-area-inset-bottom, 0px));
            }
        }
        
        /* Prevent zoom on input focus (Android) */
        input, select, textarea {
            font-size: 16px !important;
            transform-origin: left top;
            -webkit-user-select: text;
        }
        
        /* Smooth scrolling for mobile */
        .mobile-scroll {
            -webkit-overflow-scrolling: touch;
            overflow-y: auto;
            overscroll-behavior: contain;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        .offline-overlay {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar-btn {
            color: #6b7280;
        }
        .sidebar-btn:hover {
            background-color: #f3f4f6;
            color: #374151;
        }
        .sidebar-btn.active {
            background-color: #dbeafe;
            color: #2563eb;
            font-weight: 600;
        }
        @media (max-width: 1024px) {
            .sidebar-mobile {
                transform: translateX(-100%);
            }
            .sidebar-mobile.open {
                transform: translateX(0);
            }
        }
        
        /* Android Chrome address bar hide */
        @media screen and (max-width: 768px) {
            .chrome-fullscreen {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
            }
        }
        
        /* Prevent pull-to-refresh on Android */
        body {
            overscroll-behavior-y: contain;
        }
        
        /* Hide scrollbars but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="h-full bg-gradient-to-br from-blue-50 to-indigo-100 font-sans mobile-fullscreen">
    <!-- Status Bar Overlay for Android -->
    <div class="status-bar-overlay"></div>
    
    <!-- Offline Notice -->
    <div id="offlineNotice" class="fixed inset-0 offline-overlay flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 mx-4 text-center max-w-md">
            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-moon text-gray-600 text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Aplikasi Sedang Offline</h2>
            <p class="text-gray-600 mb-4">Sistem tagihan beroperasi dari jam 07:00 - 23:00</p>
            <p class="text-sm text-gray-500">Silakan kembali pada jam operasional</p>
            <div id="currentTime" class="mt-4 text-lg font-semibold text-blue-600"></div>
        </div>
    </div>

    <!-- Login/Register Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 mobile-content">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 fade-in">
            <div class="p-6 sm:p-8">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-file-invoice-dollar text-white text-2xl"></i>
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Sistem Tagihan</h2>
                    <p class="text-gray-600 mt-2 text-sm sm:text-base">Kelola tagihan dengan mudah</p>
                </div>

                <!-- Login Form -->
                <form id="loginForm" class="space-y-4">
                    <div>
                        <label for="loginEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="loginEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 text-base">
                        Masuk
                    </button>
                </form>

                <!-- Register Form (Hidden) -->
                <form id="registerForm" class="space-y-4 hidden">
                    <div>
                        <label for="registerName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                        <input type="text" id="registerName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                    </div>
                    <div>
                        <label for="registerEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="registerEmail" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="registerPassword" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                    </div>
                    <div>
                        <label for="registerRole" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                        <select id="registerRole" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                            <option value="">Pilih Role</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 text-base">
                        Daftar
                    </button>
                </form>

                <div class="mt-6 text-center">
                    <button id="toggleAuth" class="text-blue-600 hover:text-blue-800 font-medium text-sm">
                        Belum punya akun? Daftar di sini
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" class="hidden h-full flex flex-col lg:flex-row mobile-content chrome-fullscreen">
        <!-- Mobile Header -->
        <div class="lg:hidden bg-white shadow-sm border-b border-gray-200 p-4 flex-shrink-0">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button id="mobileMenuBtn" class="p-2 rounded-lg hover:bg-gray-100">
                        <i class="fas fa-bars text-gray-600"></i>
                    </button>
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-file-invoice-dollar text-white text-sm"></i>
                    </div>
                    <h1 class="text-lg font-bold text-gray-800">Sistem Tagihan</h1>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-600">Online</span>
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                </div>
            </div>
        </div>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobileOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden"></div>
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed lg:relative inset-y-0 left-0 z-50 w-64 bg-white shadow-lg border-r border-gray-200 flex flex-col transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex-shrink-0">
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-gray-200 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                            <i class="fas fa-file-invoice-dollar text-white text-lg"></i>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-gray-800">Sistem Tagihan</h1>
                            <p class="text-xs text-gray-600" id="userWelcome">Selamat datang!</p>
                        </div>
                    </div>
                    <button id="closeSidebarBtn" class="lg:hidden p-1 rounded hover:bg-gray-100">
                        <i class="fas fa-times text-gray-600"></i>
                    </button>
                </div>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="flex-1 p-4 mobile-scroll hide-scrollbar">
                <ul class="space-y-2">
                    <li>
                        <button class="sidebar-btn active w-full text-left px-4 py-3 rounded-lg transition-colors" data-tab="dashboard">
                            <i class="fas fa-tachometer-alt mr-3 w-4"></i>Dashboard
                        </button>
                    </li>
                    <li>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-4 py-2">Data Tagihan</div>
                        <ul class="space-y-1">
                            <li>
                                <button class="sidebar-btn w-full text-left px-4 py-2 rounded-lg transition-colors text-sm" data-tab="bills">
                                    <i class="fas fa-plus-circle mr-3 w-4"></i>Tambah Tagihan
                                </button>
                            </li>
                            <li>
                                <button class="sidebar-btn w-full text-left px-4 py-2 rounded-lg transition-colors text-sm" data-tab="history">
                                    <i class="fas fa-list mr-3 w-4"></i>Kelola Tagihan
                                </button>
                            </li>
                        </ul>
                    </li>
                    <li>
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-4 py-2 mt-4">Laporan</div>
                        <ul class="space-y-1">
                            <li>
                                <button class="sidebar-btn w-full text-left px-4 py-2 rounded-lg transition-colors text-sm" data-tab="reports" id="reportsTab" style="display: none;">
                                    <i class="fas fa-chart-bar mr-3 w-4"></i>Laporan & Export
                                </button>
                            </li>
                        </ul>
                    </li>
                    <li id="adminSection" style="display: none;">
                        <div class="text-xs font-semibold text-gray-500 uppercase tracking-wider px-4 py-2 mt-4">Admin</div>
                        <ul class="space-y-1">
                            <li>
                                <button class="sidebar-btn w-full text-left px-4 py-2 rounded-lg transition-colors text-sm" data-tab="users" id="usersTab">
                                    <i class="fas fa-users mr-3 w-4"></i>Kelola User
                                </button>
                            </li>
                            <li>
                                <button class="sidebar-btn w-full text-left px-4 py-2 rounded-lg transition-colors text-sm" data-tab="generate" id="generateTab">
                                    <i class="fas fa-magic mr-3 w-4"></i>Generate Data
                                </button>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-gray-200 flex-shrink-0">
                <div class="text-xs text-gray-600 mb-2" id="liveTime"></div>
                <button id="logoutBtn" class="w-full bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg transition-colors text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Keluar
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col min-h-0">
            <!-- Desktop Header -->
            <header class="hidden lg:block bg-white shadow-sm border-b border-gray-200 px-6 py-4 flex-shrink-0">
                <div class="flex items-center justify-between">
                    <h2 id="pageTitle" class="text-xl font-semibold text-gray-800">Dashboard</h2>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600">Online</span>
                        <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <main class="flex-1 bg-gray-50 mobile-scroll hide-scrollbar">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="tab-content p-3 lg:p-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-6 lg:mb-8">
                        <div class="bg-white rounded-xl shadow-md p-4 lg:p-6 border-l-4 border-blue-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Total Tagihan</p>
                                    <p class="text-xl lg:text-2xl font-bold text-gray-800" id="totalBills">0</p>
                                </div>
                                <div class="w-10 h-10 lg:w-12 lg:h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-file-invoice-dollar text-blue-600 text-lg lg:text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-4 lg:p-6 border-l-4 border-green-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Lunas</p>
                                    <p class="text-xl lg:text-2xl font-bold text-gray-800" id="paidBills">0</p>
                                </div>
                                <div class="w-10 h-10 lg:w-12 lg:h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle text-green-600 text-lg lg:text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-4 lg:p-6 border-l-4 border-yellow-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Pending</p>
                                    <p class="text-xl lg:text-2xl font-bold text-gray-800" id="pendingBills">0</p>
                                </div>
                                <div class="w-10 h-10 lg:w-12 lg:h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-clock text-yellow-600 text-lg lg:text-xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-md p-4 lg:p-6 border-l-4 border-red-500">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm text-gray-600">Overdue</p>
                                    <p class="text-xl lg:text-2xl font-bold text-gray-800" id="overdueBills">0</p>
                                </div>
                                <div class="w-10 h-10 lg:w-12 lg:h-12 bg-red-100 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-lg lg:text-xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-md p-4 lg:p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Tagihan Terbaru</h3>
                        <div class="mobile-scroll hide-scrollbar">
                            <div id="recentBills" class="space-y-3">
                                <p class="text-gray-500 text-center py-8">Belum ada data tagihan</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bills Input Tab -->
                <div id="bills" class="tab-content hidden p-3 lg:p-6">
                    <div class="bg-white rounded-xl shadow-md p-4 lg:p-6 max-w-4xl mx-auto">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-6 space-y-3 sm:space-y-0">
                            <h3 class="text-lg lg:text-xl font-semibold text-gray-800" id="formTitle">Tambah Data Tagihan</h3>
                            <button id="cancelEdit" class="hidden bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-sm w-full sm:w-auto">
                                <i class="fas fa-times mr-2"></i>Batal Edit
                            </button>
                        </div>
                        <form id="billForm" class="space-y-4">
                            <input type="hidden" id="editId" value="">
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-2">Nama Pelanggan</label>
                                    <input type="text" id="customerName" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                                </div>
                                <div>
                                    <label for="customerPhone" class="block text-sm font-medium text-gray-700 mb-2">No. Telepon</label>
                                    <input type="tel" id="customerPhone" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                                </div>
                            </div>
                            
                            <div>
                                <label for="customerAddress" class="block text-sm font-medium text-gray-700 mb-2">Alamat</label>
                                <textarea id="customerAddress" required rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base"></textarea>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <label for="billAmount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Tagihan (Rp)</label>
                                    <input type="number" id="billAmount" required min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                                </div>
                                <div>
                                    <label for="dueDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal Jatuh Tempo</label>
                                    <input type="date" id="dueDate" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <label for="billStatus" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                    <select id="billStatus" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                                        <option value="">Pilih Status</option>
                                        <option value="pending">Pending</option>
                                        <option value="paid">Lunas</option>
                                        <option value="overdue">Overdue</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="billOfficer" class="block text-sm font-medium text-gray-700 mb-2">Petugas</label>
                                    <select id="billOfficer" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base">
                                        <option value="">Pilih Petugas</option>
                                        <option value="Mario Haulussy">Mario Haulussy</option>
                                        <option value="Macho Haulussy">Macho Haulussy</option>
                                        <option value="Ryan Pattiwael">Ryan Pattiwael</option>
                                        <option value="Stevy Wuarlela">Stevy Wuarlela</option>
                                        <option value="Stevian Lauluw">Stevian Lauluw</option>
                                        <option value="Gilberd">Gilberd</option>
                                        <option value="Glen Tansora">Glen Tansora</option>
                                        <option value="Glen Ohman">Glen Ohman</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="billDescription" class="block text-sm font-medium text-gray-700 mb-2">Keterangan</label>
                                <textarea id="billDescription" rows="3" placeholder="Masukkan keterangan tagihan (opsional)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-base"></textarea>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-700 transition-all transform hover:scale-105 text-base">
                                <i class="fas fa-save mr-2"></i><span id="submitText">Simpan Tagihan</span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- History Tab -->
                <div id="history" class="tab-content hidden p-3 lg:p-6">
                    <div class="bg-white rounded-xl shadow-md p-4 lg:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                            <h3 class="text-lg lg:text-xl font-semibold text-gray-800">Kelola Data Tagihan</h3>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                                <input type="text" id="searchInput" placeholder="Cari nama pelanggan..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base">
                                <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base">
                                    <option value="">Semua Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="paid">Lunas</option>
                                    <option value="overdue">Overdue</option>
                                </select>
                            </div>
                        </div>
                        <div class="mobile-scroll hide-scrollbar">
                            <div id="billsList" class="space-y-3">
                                <p class="text-gray-500 text-center py-8">Belum ada data tagihan</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports" class="tab-content hidden p-3 lg:p-6">
                    <div class="bg-white rounded-xl shadow-md p-4 lg:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                            <h3 class="text-lg lg:text-xl font-semibold text-gray-800">Laporan & Export</h3>
                            <div class="grid grid-cols-2 lg:flex gap-2 w-full sm:w-auto">
                                <button id="exportExcel" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg transition-colors text-xs lg:text-sm">
                                    <i class="fas fa-file-excel mr-1 lg:mr-2"></i>Excel
                                </button>
                                <button id="exportPDF" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg transition-colors text-xs lg:text-sm">
                                    <i class="fas fa-file-pdf mr-1 lg:mr-2"></i>PDF
                                </button>
                                <button id="exportJSON" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg transition-colors text-xs lg:text-sm">
                                    <i class="fas fa-download mr-1 lg:mr-2"></i>Export
                                </button>
                                <button id="importJSON" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-2 rounded-lg transition-colors text-xs lg:text-sm">
                                    <i class="fas fa-upload mr-1 lg:mr-2"></i>Import JSON
                                </button>
                                <button id="importExcel" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-lg transition-colors text-xs lg:text-sm">
                                    <i class="fas fa-file-excel mr-1 lg:mr-2"></i>Import Excel
                                </button>
                                <button id="importPDF" class="bg-red-600 hover:bg-red-700 text-white px-3 py-2 rounded-lg transition-colors text-xs lg:text-sm">
                                    <i class="fas fa-file-pdf mr-1 lg:mr-2"></i>Import PDF
                                </button>
                            </div>
                        </div>
                        
                        <!-- Import/Export Section -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 mb-6">
                            <div class="flex items-start">
                                <i class="fas fa-sync-alt text-blue-600 mr-3 mt-1 text-lg"></i>
                                <div>
                                    <h4 class="font-semibold text-blue-800 mb-2">üîÑ Sinkronisasi Data Multi-Device</h4>
                                    <p class="text-blue-700 text-sm mb-3">Bagikan data tagihan antar HP/Laptop dengan mudah:</p>
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 text-sm">
                                        <div class="bg-white rounded-lg p-3 border border-blue-100">
                                            <h5 class="font-semibold text-blue-800 mb-2">üì§ Cara Export (Pengirim)</h5>
                                            <ol class="text-blue-700 list-decimal list-inside space-y-1">
                                                <li>Klik tombol "Export/Excel" di atas</li>
                                                <li><strong>Mobile:</strong> Pilih Download/Share/Copy</li>
                                                <li><strong>Desktop:</strong> File auto-download</li>
                                                <li>Kirim file via WhatsApp/Email</li>
                                            </ol>
                                            <div class="mt-2 p-2 bg-blue-50 rounded text-xs">
                                                <strong>üì± Tips Mobile:</strong> Jika JSON gagal, gunakan Excel export yang lebih kompatibel
                                            </div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border border-blue-100">
                                            <h5 class="font-semibold text-blue-800 mb-2">üì• Cara Import (Penerima)</h5>
                                            <ol class="text-blue-700 list-decimal list-inside space-y-1">
                                                <li>Terima file dari pengirim</li>
                                                <li>Klik "Import JSON" atau "Import Excel"</li>
                                                <li>Pilih file yang diterima</li>
                                                <li>Data otomatis tersinkronisasi</li>
                                            </ol>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border border-orange-100">
                                            <h5 class="font-semibold text-orange-800 mb-2">üìä Import Excel (Alternatif 1)</h5>
                                            <ol class="text-orange-700 list-decimal list-inside space-y-1">
                                                <li><strong>Mobile:</strong> Export ke Excel</li>
                                                <li>Kirim file .xlsx via WhatsApp</li>
                                                <li><strong>Admin PC:</strong> Import Excel</li>
                                                <li>Data otomatis dikonversi</li>
                                            </ol>
                                            <div class="mt-2 p-2 bg-orange-50 rounded text-xs">
                                                <strong>üí° Keunggulan:</strong> Excel lebih kompatibel di semua device & mudah diedit manual
                                            </div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3 border border-red-100">
                                            <h5 class="font-semibold text-red-800 mb-2">üìÑ Import PDF (Alternatif 2)</h5>
                                            <ol class="text-red-700 list-decimal list-inside space-y-1">
                                                <li><strong>Mobile:</strong> Export ke PDF</li>
                                                <li>Kirim file .pdf via WhatsApp</li>
                                                <li><strong>Admin PC:</strong> Import PDF</li>
                                                <li>OCR otomatis ekstrak data</li>
                                            </ol>
                                            <div class="mt-2 p-2 bg-red-50 rounded text-xs">
                                                <strong>üîç Keunggulan:</strong> PDF universal, OCR smart parsing, backup visual data
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3 p-2 bg-blue-100 rounded border border-blue-200">
                                        <p class="text-blue-800 text-xs">‚úÖ <strong>Keamanan:</strong> Data tidak duplikat, merge otomatis, tracking lengkap. Mendukung JSON, Excel & PDF import.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hidden file inputs for import -->
                        <input type="file" id="importFile" accept=".json" style="display: none;">
                        <input type="file" id="importExcelFile" accept=".xlsx,.xls" style="display: none;">
                        <input type="file" id="importPDFFile" accept=".pdf" style="display: none;">
                        
                        <!-- Sync Status -->
                        <div id="syncStatus" class="hidden mb-6">
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                    <span class="text-green-800 font-semibold">Data berhasil disinkronisasi!</span>
                                </div>
                                <p class="text-green-700 text-sm mt-1" id="syncDetails"></p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-4">Ringkasan Bulanan</h4>
                                <div id="monthlyReport" class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Total Tagihan:</span>
                                        <span class="font-semibold" id="monthlyTotal">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Sudah Dibayar:</span>
                                        <span class="font-semibold text-green-600" id="monthlyPaid">Rp 0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Belum Dibayar:</span>
                                        <span class="font-semibold text-red-600" id="monthlyUnpaid">Rp 0</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4">
                                <h4 class="font-semibold text-gray-800 mb-4">Status Tagihan</h4>
                                <div id="statusReport" class="space-y-2">
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Pending:</span>
                                        <span class="font-semibold" id="pendingCount">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Lunas:</span>
                                        <span class="font-semibold" id="paidCount">0</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-gray-600">Overdue:</span>
                                        <span class="font-semibold" id="overdueCount">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Management Tab -->
                <div id="users" class="tab-content hidden p-3 lg:p-6">
                    <div class="bg-white rounded-xl shadow-md p-4 lg:p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                            <h3 class="text-lg lg:text-xl font-semibold text-gray-800">Kelola User</h3>
                            <button id="addUserBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm w-full sm:w-auto">
                                <i class="fas fa-plus mr-2"></i>Tambah User
                            </button>
                        </div>
                        
                        <!-- Add User Form -->
                        <div id="addUserForm" class="hidden bg-gray-50 rounded-lg p-4 mb-6">
                            <h4 class="font-semibold text-gray-800 mb-4">Tambah User Baru</h4>
                            <form id="userForm" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                <div>
                                    <label for="newUserName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                    <input type="text" id="newUserName" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base">
                                </div>
                                <div>
                                    <label for="newUserEmail" class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                    <input type="email" id="newUserEmail" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base">
                                </div>
                                <div>
                                    <label for="newUserPassword" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                    <input type="password" id="newUserPassword" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base">
                                </div>
                                <div>
                                    <label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                                    <select id="newUserRole" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base">
                                        <option value="">Pilih Role</option>
                                        <option value="admin">Admin</option>
                                        <option value="user">User</option>
                                    </select>
                                </div>
                                <div class="lg:col-span-2 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors text-sm flex-1 sm:flex-none">
                                        <i class="fas fa-save mr-2"></i>Simpan User
                                    </button>
                                    <button type="button" id="cancelAddUser" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors text-sm flex-1 sm:flex-none">
                                        <i class="fas fa-times mr-2"></i>Batal
                                    </button>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Users List -->
                        <div class="mobile-scroll hide-scrollbar">
                            <div id="usersList" class="space-y-3">
                                <!-- Users will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Generate Data Tab -->
                <div id="generate" class="tab-content hidden p-3 lg:p-6">
                    <div class="bg-white rounded-xl shadow-md p-4 lg:p-6">
                        <h3 class="text-lg lg:text-xl font-semibold text-gray-800 mb-6">Generate Data Tagihan</h3>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>
                                <p class="text-yellow-800 text-sm">Fitur ini akan membuat data tagihan dummy untuk testing. Data yang sudah ada tidak akan terhapus.</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <label for="generateCount" class="block text-sm font-medium text-gray-700 mb-2">Jumlah Data yang Akan Dibuat</label>
                                <select id="generateCount" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-base">
                                    <option value="10">10 Data</option>
                                    <option value="25">25 Data</option>
                                    <option value="50">50 Data</option>
                                    <option value="100">100 Data</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status Data</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="genPending" checked class="mr-2">
                                        <span class="text-sm">Pending</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="genPaid" checked class="mr-2">
                                        <span class="text-sm">Lunas</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="genOverdue" checked class="mr-2">
                                        <span class="text-sm">Overdue</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <button id="generateDataBtn" class="mt-6 bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg transition-colors font-semibold w-full lg:w-auto">
                            <i class="fas fa-magic mr-2"></i>Generate Data Tagihan
                        </button>
                        
                        <div id="generateProgress" class="hidden mt-4">
                            <div class="bg-gray-200 rounded-full h-2">
                                <div id="progressBar" class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                            <p class="text-sm text-gray-600 mt-2">Sedang membuat data...</p>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 mx-4 max-w-sm w-full text-center fade-in">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-green-600 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Berhasil!</h3>
            <p id="successMessage" class="text-gray-600 mb-4">Data berhasil disimpan</p>
            <button id="closeSuccessModal" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                OK
            </button>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 mx-4 max-w-sm w-full text-center fade-in">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-trash text-red-600 text-2xl"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Konfirmasi Hapus</h3>
            <p class="text-gray-600 mb-6">Apakah Anda yakin ingin menghapus data tagihan ini? Tindakan ini tidak dapat dibatalkan.</p>
            <div class="flex space-x-3">
                <button id="cancelDelete" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    Batal
                </button>
                <button id="confirmDelete" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                    Hapus
                </button>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let currentUser = null;
        let bills = JSON.parse(localStorage.getItem('bills')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [
            { id: 1, name: 'Admin', email: 'admin@admin.com', password: 'admin123', role: 'admin' },
            { id: 2, name: 'User', email: 'user@user.com', password: 'user123', role: 'user' }
        ];

        // Mobile fullscreen functionality
        function initMobileFullscreen() {
            // Force fullscreen on mobile
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                // Hide address bar on Android
                window.addEventListener('load', function() {
                    setTimeout(function() {
                        window.scrollTo(0, 1);
                    }, 0);
                });
                
                // Prevent zoom on input focus
                document.addEventListener('touchstart', function() {}, true);
                
                // Handle orientation change
                window.addEventListener('orientationchange', function() {
                    setTimeout(function() {
                        window.scrollTo(0, 1);
                    }, 500);
                });
                
                // Prevent pull-to-refresh
                document.body.addEventListener('touchstart', function(e) {
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        if (touch.clientY <= 50 && window.pageYOffset === 0) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });
                
                document.body.addEventListener('touchmove', function(e) {
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        if (touch.clientY <= 50 && window.pageYOffset === 0) {
                            e.preventDefault();
                        }
                    }
                }, { passive: false });
            }
        }

        // Mobile menu functionality
        function initMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const closeSidebarBtn = document.getElementById('closeSidebarBtn');
            const sidebar = document.getElementById('sidebar');
            const mobileOverlay = document.getElementById('mobileOverlay');

            function openSidebar() {
                sidebar.classList.remove('-translate-x-full');
                mobileOverlay.classList.remove('hidden');
            }

            function closeSidebar() {
                sidebar.classList.add('-translate-x-full');
                mobileOverlay.classList.add('hidden');
            }

            mobileMenuBtn.addEventListener('click', openSidebar);
            closeSidebarBtn.addEventListener('click', closeSidebar);
            mobileOverlay.addEventListener('click', closeSidebar);

            // Close sidebar when clicking on menu items on mobile
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            });
        }

        // Check operating hours (7 AM to 11 PM)
        function checkOperatingHours() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour < 7 || hour >= 23) {
                document.getElementById('offlineNotice').classList.remove('hidden');
                document.getElementById('authModal').classList.add('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                return false;
            } else {
                document.getElementById('offlineNotice').classList.add('hidden');
                return true;
            }
        }

        // Update live time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID');
            const dateString = now.toLocaleDateString('id-ID');
            
            document.getElementById('liveTime').textContent = `${dateString} ${timeString}`;
            document.getElementById('currentTime').textContent = timeString;
        }

        // Initialize app
        function initApp() {
            if (!checkOperatingHours()) {
                setInterval(checkOperatingHours, 60000); // Check every minute
                setInterval(updateTime, 1000);
                return;
            }

            updateTime();
            setInterval(updateTime, 1000);
            setInterval(checkOperatingHours, 60000);
            initMobileMenu();
            initMobileFullscreen();

            // Check if user is logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
        }

        // Authentication functions
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
            } else {
                showMessage('Email atau password salah!', 'error');
            }
        });

        document.getElementById('registerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            
            if (users.find(u => u.email === email)) {
                showMessage('Email sudah terdaftar!', 'error');
                return;
            }
            
            const newUser = {
                id: users.length + 1,
                name,
                email,
                password,
                role
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            showMessage('Registrasi berhasil! Silakan login.', 'success');
            toggleAuthForm();
        });

        document.getElementById('toggleAuth').addEventListener('click', toggleAuthForm);

        function toggleAuthForm() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const toggleBtn = document.getElementById('toggleAuth');
            
            if (loginForm.classList.contains('hidden')) {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
                toggleBtn.textContent = 'Belum punya akun? Daftar di sini';
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                toggleBtn.textContent = 'Sudah punya akun? Login di sini';
            }
        }

        function showMainApp() {
            document.getElementById('authModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userWelcome').textContent = `Selamat datang, ${currentUser.name}!`;
            
            // Show/hide admin-only sections based on user role
            const reportsTab = document.getElementById('reportsTab');
            const adminSection = document.getElementById('adminSection');
            
            if (currentUser.role === 'admin') {
                // Show admin features
                if (reportsTab) {
                    reportsTab.style.display = 'block';
                    reportsTab.parentElement.style.display = 'block';
                }
                if (adminSection) {
                    adminSection.style.display = 'block';
                }
                loadUsersList();
            } else {
                // Hide admin features for regular users
                if (reportsTab) {
                    reportsTab.style.display = 'none';
                    reportsTab.parentElement.style.display = 'none';
                }
                if (adminSection) {
                    adminSection.style.display = 'none';
                }
            }
            
            updateDashboard();
            loadBillsHistory();
        }

        // Logout function
        document.getElementById('logoutBtn').addEventListener('click', function() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authModal').classList.remove('hidden');
        });

        // Tab navigation
        document.querySelectorAll('.sidebar-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                showTab(tabName);
            });
        });

        function showTab(tabName) {
            // Update sidebar buttons
            document.querySelectorAll('.sidebar-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'bills': 'Tambah Data Tagihan',
                'history': 'Kelola Data Tagihan',
                'reports': 'Laporan & Export',
                'users': 'Kelola User',
                'generate': 'Generate Data'
            };
            document.getElementById('pageTitle').textContent = titles[tabName] || 'Dashboard';
            
            // Show/hide content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabName).classList.remove('hidden');
            
            if (tabName === 'reports') {
                updateReports();
            }
        }

        // CRUD Variables
        let editingId = null;
        let deleteId = null;

        // Bills form
        document.getElementById('billForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const editId = document.getElementById('editId').value;
            
            const formData = {
                id: editId ? parseInt(editId) : Date.now(),
                customerName: document.getElementById('customerName').value,
                customerPhone: document.getElementById('customerPhone').value,
                customerAddress: document.getElementById('customerAddress').value,
                amount: parseFloat(document.getElementById('billAmount').value),
                dueDate: document.getElementById('dueDate').value,
                status: document.getElementById('billStatus').value,
                description: document.getElementById('billDescription').value,
                officer: document.getElementById('billOfficer').value,
                createdAt: editId ? bills.find(b => b.id == editId).createdAt : new Date().toISOString(),
                createdBy: editId ? bills.find(b => b.id == editId).createdBy : currentUser.name,
                updatedAt: editId ? new Date().toISOString() : null,
                updatedBy: editId ? currentUser.name : null
            };
            
            if (editId) {
                // Update existing bill
                const index = bills.findIndex(b => b.id == editId);
                if (index !== -1) {
                    bills[index] = formData;
                    showSuccessModal('Data tagihan berhasil diperbarui!');
                }
            } else {
                // Add new bill
                bills.push(formData);
                showSuccessModal('Data tagihan berhasil disimpan!');
            }
            
            localStorage.setItem('bills', JSON.stringify(bills));
            
            // Reset form
            resetForm();
            
            // Update dashboard and history
            updateDashboard();
            loadBillsHistory();
        });

        // Cancel edit
        document.getElementById('cancelEdit').addEventListener('click', function() {
            resetForm();
        });

        // Reset form function
        function resetForm() {
            document.getElementById('billForm').reset();
            document.getElementById('editId').value = '';
            document.getElementById('formTitle').textContent = 'Tambah Data Tagihan';
            document.getElementById('submitText').textContent = 'Simpan Tagihan';
            document.getElementById('cancelEdit').classList.add('hidden');
            editingId = null;
        }

        // Edit bill function
        function editBill(id) {
            const bill = bills.find(b => b.id == id);
            if (!bill) return;
            
            // Fill form with bill data
            document.getElementById('editId').value = bill.id;
            document.getElementById('customerName').value = bill.customerName;
            document.getElementById('customerPhone').value = bill.customerPhone;
            document.getElementById('customerAddress').value = bill.customerAddress;
            document.getElementById('billAmount').value = bill.amount;
            document.getElementById('dueDate').value = bill.dueDate;
            document.getElementById('billStatus').value = bill.status;
            document.getElementById('billDescription').value = bill.description || '';
            document.getElementById('billOfficer').value = bill.officer || '';
            
            // Update form UI
            document.getElementById('formTitle').textContent = 'Edit Data Tagihan';
            document.getElementById('submitText').textContent = 'Update Tagihan';
            document.getElementById('cancelEdit').classList.remove('hidden');
            
            // Switch to bills tab
            showTab('bills');
            editingId = id;
        }

        // Delete bill function
        function deleteBill(id) {
            deleteId = id;
            document.getElementById('deleteModal').classList.remove('hidden');
        }

        // Delete modal handlers
        document.getElementById('cancelDelete').addEventListener('click', function() {
            document.getElementById('deleteModal').classList.add('hidden');
            deleteId = null;
        });

        document.getElementById('confirmDelete').addEventListener('click', function() {
            if (deleteId) {
                bills = bills.filter(b => b.id != deleteId);
                localStorage.setItem('bills', JSON.stringify(bills));
                
                showSuccessModal('Data tagihan berhasil dihapus!');
                updateDashboard();
                loadBillsHistory();
                
                document.getElementById('deleteModal').classList.add('hidden');
                deleteId = null;
            }
        });

        // Dashboard functions
        function updateDashboard() {
            const totalBills = bills.length;
            const paidBills = bills.filter(bill => bill.status === 'paid').length;
            const pendingBills = bills.filter(bill => bill.status === 'pending').length;
            const overdueBills = bills.filter(bill => bill.status === 'overdue').length;
            
            document.getElementById('totalBills').textContent = totalBills;
            document.getElementById('paidBills').textContent = paidBills;
            document.getElementById('pendingBills').textContent = pendingBills;
            document.getElementById('overdueBills').textContent = overdueBills;
            
            // Show recent bills
            const recentBills = bills.slice(-5).reverse();
            const recentBillsContainer = document.getElementById('recentBills');
            
            if (recentBills.length === 0) {
                recentBillsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada data tagihan</p>';
            } else {
                recentBillsContainer.innerHTML = recentBills.map(bill => `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-gray-50 rounded-lg space-y-2 sm:space-y-0">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${bill.customerName}</h4>
                            <p class="text-sm text-gray-600">${bill.customerPhone}</p>
                            <p class="text-sm text-gray-500">Jatuh tempo: ${new Date(bill.dueDate).toLocaleDateString('id-ID')}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-semibold text-gray-800">Rp ${bill.amount.toLocaleString('id-ID')}</p>
                            <span class="inline-block px-2 py-1 text-xs rounded-full ${getStatusColor(bill.status)}">${getStatusText(bill.status)}</span>
                        </div>
                    </div>
                `).join('');
            }
        }

        // History functions
        function loadBillsHistory() {
            const billsList = document.getElementById('billsList');
            let filteredBills = [...bills];
            
            // Apply filters
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            
            if (searchTerm) {
                filteredBills = filteredBills.filter(bill => 
                    bill.customerName.toLowerCase().includes(searchTerm)
                );
            }
            
            if (statusFilter) {
                filteredBills = filteredBills.filter(bill => bill.status === statusFilter);
            }
            
            if (filteredBills.length === 0) {
                billsList.innerHTML = '<p class="text-gray-500 text-center py-8">Tidak ada data yang ditemukan</p>';
            } else {
                billsList.innerHTML = filteredBills.reverse().map(bill => `
                    <div class="bg-white rounded-lg p-4 space-y-3 shadow-sm border border-gray-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${bill.customerName}</h4>
                                <p class="text-sm text-gray-600">${bill.customerPhone}</p>
                                <p class="text-sm text-gray-500">${bill.customerAddress}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-lg text-gray-800">Rp ${bill.amount.toLocaleString('id-ID')}</p>
                                <span class="inline-block px-3 py-1 text-sm rounded-full ${getStatusColor(bill.status)}">${getStatusText(bill.status)}</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm text-gray-600">
                            <div><strong>Jatuh Tempo:</strong> ${new Date(bill.dueDate).toLocaleDateString('id-ID')}</div>
                            <div><strong>Petugas:</strong> ${bill.officer || '-'}</div>
                        </div>
                        ${bill.description ? `<div class="text-sm text-gray-600"><strong>Keterangan:</strong> ${bill.description}</div>` : ''}
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                            <div class="text-xs text-gray-500">
                                Dibuat oleh: ${bill.createdBy} pada ${new Date(bill.createdAt).toLocaleDateString('id-ID')}
                                ${bill.updatedAt ? `<br>Diperbarui: ${new Date(bill.updatedAt).toLocaleDateString('id-ID')} oleh ${bill.updatedBy}` : ''}
                            </div>
                            <div class="flex space-x-2 w-full sm:w-auto">
                                <button onclick="editBill(${bill.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm transition-colors flex-1 sm:flex-none">
                                    <i class="fas fa-edit mr-1"></i>Edit
                                </button>
                                <button onclick="deleteBill(${bill.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors flex-1 sm:flex-none">
                                    <i class="fas fa-trash mr-1"></i>Hapus
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Search and filter
        document.getElementById('searchInput').addEventListener('input', loadBillsHistory);
        document.getElementById('statusFilter').addEventListener('change', loadBillsHistory);

        // Reports functions
        function updateReports() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyBills = bills.filter(bill => {
                const billDate = new Date(bill.createdAt);
                return billDate.getMonth() === currentMonth && billDate.getFullYear() === currentYear;
            });
            
            const totalAmount = monthlyBills.reduce((sum, bill) => sum + bill.amount, 0);
            const paidAmount = monthlyBills.filter(bill => bill.status === 'paid').reduce((sum, bill) => sum + bill.amount, 0);
            const unpaidAmount = totalAmount - paidAmount;
            
            document.getElementById('monthlyTotal').textContent = `Rp ${totalAmount.toLocaleString('id-ID')}`;
            document.getElementById('monthlyPaid').textContent = `Rp ${paidAmount.toLocaleString('id-ID')}`;
            document.getElementById('monthlyUnpaid').textContent = `Rp ${unpaidAmount.toLocaleString('id-ID')}`;
            
            // Status counts
            const pendingCount = bills.filter(bill => bill.status === 'pending').length;
            const paidCount = bills.filter(bill => bill.status === 'paid').length;
            const overdueCount = bills.filter(bill => bill.status === 'overdue').length;
            
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('paidCount').textContent = paidCount;
            document.getElementById('overdueCount').textContent = overdueCount;
        }

        // Export functions
        document.getElementById('exportExcel').addEventListener('click', function() {
            const ws = XLSX.utils.json_to_sheet(bills.map(bill => ({
                'Nama Pelanggan': bill.customerName,
                'No. Telepon': bill.customerPhone,
                'Alamat': bill.customerAddress,
                'Jumlah Tagihan': bill.amount,
                'Tanggal Jatuh Tempo': bill.dueDate,
                'Status': bill.status,
                'Petugas': bill.officer || '',
                'Keterangan': bill.description || '',
                'Tanggal Dibuat': new Date(bill.createdAt).toLocaleDateString('id-ID'),
                'Dibuat Oleh': bill.createdBy
            })));
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data Tagihan');
            XLSX.writeFile(wb, `data-tagihan-${new Date().toISOString().split('T')[0]}.xlsx`);
        });

        // Export JSON Data for sync - IMPROVED FOR MOBILE
        document.getElementById('exportJSON').addEventListener('click', function() {
            const exportData = {
                bills: bills,
                users: users.filter(u => u.id > 2), // Don't export default users
                exportDate: new Date().toISOString(),
                exportBy: currentUser.name,
                exportFrom: 'Sistem Tagihan v2.0',
                deviceInfo: navigator.userAgent.includes('Mobile') ? 'Mobile Device' : 'Desktop/Laptop',
                totalBills: bills.length,
                totalUsers: users.filter(u => u.id > 2).length,
                version: '2.0'
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const fileName = `sistem-tagihan-sync-${new Date().toISOString().split('T')[0]}-${Date.now()}.json`;
            
            // Check if device is mobile
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (isMobile) {
                // For mobile devices, show options modal
                showMobileExportModal(dataStr, fileName);
            } else {
                // Desktop: use traditional download
                downloadFile(dataStr, fileName);
                showSuccessModal(`‚úÖ Data berhasil di-export!\n\nüìä ${bills.length} tagihan & ${users.filter(u => u.id > 2).length} user\nüì± File siap dibagikan ke device lain\nüîÑ Gunakan tombol Import di device tujuan`);
            }
        });
        
        function downloadFile(dataStr, fileName) {
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = fileName;
            
            // For mobile browsers, add target="_blank" and force click
            if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Show additional instructions for mobile
                setTimeout(() => {
                    showSuccessModal(`üì± MOBILE DOWNLOAD:\n\n‚úÖ File JSON sedang diunduh\nüìÅ Cek folder Download di HP\nüì§ Bagikan file via WhatsApp ke admin\n\nüìã Nama file:\n${fileName}\n\nüí° Jika tidak terunduh, gunakan browser Chrome/Firefox`);
                }, 1000);
            } else {
                link.click();
            }
            
            // Clean up
            setTimeout(() => URL.revokeObjectURL(link.href), 1000);
        }
        
        function showMobileExportModal(dataStr, fileName) {
            // Create modal for mobile export
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-96 overflow-hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">üì± Export Data Mobile</h3>
                        <p class="text-sm text-gray-600 mt-1">Pilih cara export yang sesuai</p>
                    </div>
                    <div class="p-4 space-y-3">
                        <button id="mobileDownloadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors">
                            <i class="fas fa-download mr-2"></i>Download File JSON
                        </button>
                        <button id="mobileShareBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg transition-colors">
                            <i class="fas fa-share mr-2"></i>Share via WhatsApp/Email
                        </button>
                        <button id="mobileCopyBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg transition-colors">
                            <i class="fas fa-copy mr-2"></i>Copy Data (Manual)
                        </button>
                        <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded">
                            <strong>üí° Tips:</strong><br>
                            ‚Ä¢ Download: File tersimpan di folder Download<br>
                            ‚Ä¢ Share: Langsung kirim via app yang tersedia<br>
                            ‚Ä¢ Copy: Salin data manual, paste di notepad, save sebagai .json
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200">
                        <button id="closeMobileModal" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Download button
            modal.querySelector('#mobileDownloadBtn').addEventListener('click', () => {
                downloadFile(dataStr, fileName);
                document.body.removeChild(modal);
                showSuccessModal(`üì± File JSON sedang diunduh!\n\nüìÅ Cek folder Download di HP\nüì§ Kirim file via WhatsApp ke admin\n\nüìã Nama file: ${fileName}`);
            });
            
            // Share button (Web Share API)
            modal.querySelector('#mobileShareBtn').addEventListener('click', () => {
                if (navigator.share) {
                    const file = new File([dataStr], fileName, { type: 'application/json' });
                    navigator.share({
                        title: 'Data Sistem Tagihan',
                        text: `Export data tagihan - ${bills.length} tagihan, ${users.filter(u => u.id > 2).length} user`,
                        files: [file]
                    }).then(() => {
                        document.body.removeChild(modal);
                        showSuccessModal(`‚úÖ Data berhasil di-share!\n\nüìä ${bills.length} tagihan & ${users.filter(u => u.id > 2).length} user\nüì± File siap dibagikan via WhatsApp/Email\nüîÑ Gunakan tombol Import di device tujuan`);
                    }).catch((error) => {
                        // Fallback to download
                        downloadFile(dataStr, fileName);
                        document.body.removeChild(modal);
                        showSuccessModal(`üì± Share tidak tersedia, file di-download!\n\nüìÅ Cek folder Download di HP\nüì§ Kirim file manual via WhatsApp`);
                    });
                } else {
                    // Fallback to download
                    downloadFile(dataStr, fileName);
                    document.body.removeChild(modal);
                    showSuccessModal(`üì± Share tidak tersedia, file di-download!\n\nüìÅ Cek folder Download di HP\nüì§ Kirim file manual via WhatsApp`);
                }
            });
            
            // Copy button
            modal.querySelector('#mobileCopyBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(dataStr).then(() => {
                    document.body.removeChild(modal);
                    showSuccessModal(`üìã Data berhasil di-copy!\n\nüìù Cara manual:\n1. Buka aplikasi Notes/Notepad\n2. Paste data (Ctrl+V)\n3. Save sebagai file .json\n4. Kirim file via WhatsApp\n\nüíæ Data sudah ada di clipboard`);
                }).catch(() => {
                    // Fallback: show data in textarea
                    showDataTextarea(dataStr, fileName);
                    document.body.removeChild(modal);
                });
            });
            
            // Close button
            modal.querySelector('#closeMobileModal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }
        
        function showDataTextarea(dataStr, fileName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-96 overflow-hidden">
                    <div class="p-4 border-b border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800">üìã Copy Data Manual</h3>
                        <p class="text-sm text-gray-600 mt-1">Salin semua data di bawah ini</p>
                    </div>
                    <div class="p-4">
                        <textarea readonly class="w-full h-48 text-xs border border-gray-300 rounded p-2 font-mono" onclick="this.select()">${dataStr}</textarea>
                        <div class="mt-3 text-xs text-gray-600 bg-yellow-50 p-3 rounded">
                            <strong>üìù Langkah selanjutnya:</strong><br>
                            1. Tap textarea ‚Üí Select All ‚Üí Copy<br>
                            2. Buka Notes/Notepad ‚Üí Paste<br>
                            3. Save sebagai: <strong>${fileName}</strong><br>
                            4. Kirim file via WhatsApp ke admin
                        </div>
                    </div>
                    <div class="p-4 border-t border-gray-200">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            Tutup
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Import JSON Data for sync
        document.getElementById('importJSON').addEventListener('click', function() {
            document.getElementById('importFile').click();
        });

        // Import Excel Data for sync
        document.getElementById('importExcel').addEventListener('click', function() {
            document.getElementById('importExcelFile').click();
        });

        // Import PDF Data for sync
        document.getElementById('importPDF').addEventListener('click', function() {
            document.getElementById('importPDFFile').click();
        });

        document.getElementById('importFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const importData = JSON.parse(event.target.result);
                    
                    // Validate import data structure
                    if (!importData.bills || !importData.users || !importData.version) {
                        throw new Error('Format file tidak valid');
                    }
                    
                    // Show detailed confirmation
                    showImportConfirmation(importData);
                    
                } catch (error) {
                    showSuccessModal(`‚ùå Error: File tidak valid atau rusak.\n\nüîç Pastikan menggunakan file export yang benar dari sistem yang sama.\n\nüìÑ File harus berformat JSON dengan ekstensi .json`);
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            e.target.value = '';
        });

        // PDF Import Handler
        document.getElementById('importPDFFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // Show loading message
            showSuccessModal('üìÑ Sedang memproses file PDF...\n\nüîç Mengekstrak teks dengan OCR\n‚è≥ Mohon tunggu sebentar');
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const typedArray = new Uint8Array(event.target.result);
                    
                    // Configure PDF.js
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                    
                    // Load PDF
                    pdfjsLib.getDocument(typedArray).promise.then(function(pdf) {
                        extractTextFromPDF(pdf, file.name);
                    }).catch(function(error) {
                        throw new Error('PDF tidak dapat dibaca atau rusak');
                    });
                    
                } catch (error) {
                    showSuccessModal(`‚ùå Error: File PDF tidak valid atau rusak.\n\nüîç Pastikan file PDF berisi data tagihan yang dapat dibaca.\n\nüìÑ Format yang didukung: .pdf\n\n‚ö†Ô∏è Error: ${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset file input
            e.target.value = '';
        });

        // Excel Import Handler
        document.getElementById('importExcelFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        throw new Error('File Excel kosong atau tidak valid');
                    }
                    
                    // Convert Excel data to system format
                    const convertedData = convertExcelToSystemFormat(jsonData, file.name);
                    showExcelImportConfirmation(convertedData);
                    
                } catch (error) {
                    showSuccessModal(`‚ùå Error: File Excel tidak valid atau rusak.\n\nüîç Pastikan file Excel berisi data tagihan dengan kolom yang sesuai.\n\nüìÑ Format yang didukung: .xlsx, .xls\n\n‚ö†Ô∏è Error: ${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
            
            // Reset file input
            e.target.value = '';
        });

        // PDF Text Extraction Functions
        async function extractTextFromPDF(pdf, fileName) {
            let fullText = '';
            const numPages = pdf.numPages;
            
            try {
                // Extract text from all pages
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    const page = await pdf.getPage(pageNum);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(item => item.str).join(' ');
                    fullText += pageText + '\n';
                }
                
                // Parse extracted text to data
                const parsedData = parsePDFTextToData(fullText, fileName);
                showPDFImportConfirmation(parsedData);
                
            } catch (error) {
                showSuccessModal(`‚ùå Error: Gagal mengekstrak teks dari PDF.\n\nüîç Pastikan PDF berisi teks yang dapat dibaca (bukan gambar scan).\n\nüí° Tips: Gunakan PDF yang dibuat dari aplikasi, bukan hasil scan.\n\n‚ö†Ô∏è Error: ${error.message}`);
            }
        }

        function parsePDFTextToData(text, fileName) {
            const lines = text.split('\n').filter(line => line.trim().length > 0);
            const convertedBills = [];
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // Smart parsing patterns for different PDF formats
            const patterns = {
                // Pattern 1: Table format with clear separators
                tablePattern: /(.+?)\s+(\d{10,15})\s+(.+?)\s+(Rp\s*[\d,\.]+|\d+)\s+(pending|paid|overdue|lunas|belum bayar)\s*(.+)?/gi,
                
                // Pattern 2: Line by line format
                linePattern: /nama[:\s]*(.+?)[\s\n]+(?:telepon|phone|hp)[:\s]*(\d{10,15})[\s\n]+(?:alamat|address)[:\s]*(.+?)[\s\n]+(?:jumlah|amount|total)[:\s]*(Rp\s*[\d,\.]+|\d+)[\s\n]+(?:status)[:\s]*(pending|paid|overdue|lunas|belum bayar)/gi,
                
                // Pattern 3: Structured format with labels
                structuredPattern: /(?:nama pelanggan|customer name)[:\s]*(.+?)[\s\n]+(?:no\.?\s*telepon|phone)[:\s]*(\d{10,15})[\s\n]+(?:alamat|address)[:\s]*(.+?)[\s\n]+(?:jumlah tagihan|amount)[:\s]*(Rp\s*[\d,\.]+|\d+)[\s\n]+(?:status)[:\s]*(pending|paid|overdue|lunas|belum bayar)/gi
            };
            
            let matchFound = false;
            
            // Try different parsing patterns
            for (const [patternName, pattern] of Object.entries(patterns)) {
                const matches = [...text.matchAll(pattern)];
                
                if (matches.length > 0) {
                    matchFound = true;
                    
                    matches.forEach((match, index) => {
                        try {
                            const bill = createBillFromPDFMatch(match, fileName, index, patternName);
                            if (bill) {
                                convertedBills.push(bill);
                                successCount++;
                            }
                        } catch (error) {
                            errorCount++;
                            errors.push(`Pattern ${patternName} - Match ${index + 1}: ${error.message}`);
                        }
                    });
                    
                    break; // Use first successful pattern
                }
            }
            
            // If no patterns match, try manual line-by-line parsing
            if (!matchFound) {
                const manualData = parseManualPDFLines(lines, fileName);
                convertedBills.push(...manualData.bills);
                successCount = manualData.successCount;
                errorCount = manualData.errorCount;
                errors.push(...manualData.errors);
            }
            
            return {
                bills: convertedBills,
                fileName: fileName,
                totalLines: lines.length,
                successCount: successCount,
                errorCount: errorCount,
                errors: errors,
                importDate: new Date().toISOString(),
                importBy: currentUser.name,
                extractedText: text.substring(0, 500) + '...' // First 500 chars for preview
            };
        }

        function createBillFromPDFMatch(match, fileName, index, patternName) {
            const [, name, phone, address, amount, status, description] = match;
            
            // Clean and validate data
            const cleanName = name?.trim().replace(/[^\w\s]/g, '');
            const cleanPhone = phone?.replace(/\D/g, '');
            const cleanAddress = address?.trim() || 'Alamat tidak tersedia';
            const cleanAmount = parseFloat(amount?.replace(/[^\d]/g, '') || '0');
            const cleanStatus = normalizeStatus(status?.toLowerCase());
            const cleanDescription = description?.trim() || `Imported from PDF: ${fileName}`;
            
            if (!cleanName || !cleanPhone || cleanAmount <= 0) {
                throw new Error(`Missing required data (Name: ${cleanName}, Phone: ${cleanPhone}, Amount: ${cleanAmount})`);
            }
            
            return {
                id: Date.now() + Math.random() + index,
                customerName: cleanName,
                customerPhone: cleanPhone,
                customerAddress: cleanAddress,
                amount: cleanAmount,
                dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 days from now
                status: cleanStatus,
                description: cleanDescription,
                officer: currentUser.name,
                createdAt: new Date().toISOString(),
                createdBy: `PDF Import by ${currentUser.name}`,
                importedAt: new Date().toISOString(),
                importedBy: currentUser.name,
                importSource: 'PDF File',
                importFileName: fileName,
                pdfPattern: patternName,
                pdfMatchIndex: index + 1
            };
        }

        function parseManualPDFLines(lines, fileName) {
            const billsData = [];
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            // Look for potential data in lines
            const potentialData = [];
            let currentRecord = {};
            
            lines.forEach((line, index) => {
                const lowerLine = line.toLowerCase();
                
                // Look for names (usually longer text without numbers)
                if (!currentRecord.name && line.length > 5 && !/^\d+$/.test(line) && !/^rp/i.test(line)) {
                    if (lowerLine.includes('nama') || (!lowerLine.includes('total') && !lowerLine.includes('jumlah'))) {
                        currentRecord.name = line.replace(/nama[:\s]*/gi, '').trim();
                    }
                }
                
                // Look for phone numbers
                const phoneMatch = line.match(/(\d{10,15})/);
                if (phoneMatch && !currentRecord.phone) {
                    currentRecord.phone = phoneMatch[1];
                }
                
                // Look for addresses
                if (!currentRecord.address && line.length > 10 && !phoneMatch && !/^rp/i.test(line)) {
                    if (lowerLine.includes('alamat') || lowerLine.includes('jl.') || lowerLine.includes('jalan')) {
                        currentRecord.address = line.replace(/alamat[:\s]*/gi, '').trim();
                    }
                }
                
                // Look for amounts
                const amountMatch = line.match(/(?:rp\s*)?(\d{1,3}(?:[,\.]\d{3})*(?:[,\.]\d{2})?)/i);
                if (amountMatch && !currentRecord.amount) {
                    currentRecord.amount = parseFloat(amountMatch[1].replace(/[,\.]/g, ''));
                }
                
                // Look for status
                if (lowerLine.includes('lunas') || lowerLine.includes('paid')) {
                    currentRecord.status = 'paid';
                } else if (lowerLine.includes('pending')) {
                    currentRecord.status = 'pending';
                } else if (lowerLine.includes('overdue') || lowerLine.includes('terlambat')) {
                    currentRecord.status = 'overdue';
                }
                
                // If we have enough data, save the record
                if (currentRecord.name && currentRecord.phone && currentRecord.amount) {
                    try {
                        const bill = {
                            id: Date.now() + Math.random() + successCount,
                            customerName: currentRecord.name,
                            customerPhone: currentRecord.phone,
                            customerAddress: currentRecord.address || 'Alamat dari PDF',
                            amount: currentRecord.amount,
                            dueDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                            status: currentRecord.status || 'pending',
                            description: `Manual parsing from PDF: ${fileName}`,
                            officer: currentUser.name,
                            createdAt: new Date().toISOString(),
                            createdBy: `PDF Manual Import by ${currentUser.name}`,
                            importedAt: new Date().toISOString(),
                            importedBy: currentUser.name,
                            importSource: 'PDF Manual Parse',
                            importFileName: fileName,
                            pdfLineNumber: index + 1
                        };
                        
                        billsData.push(bill);
                        successCount++;
                        currentRecord = {}; // Reset for next record
                        
                    } catch (error) {
                        errorCount++;
                        errors.push(`Line ${index + 1}: ${error.message}`);
                        currentRecord = {};
                    }
                }
            });
            
            return { bills: billsData, successCount, errorCount, errors };
        }

        function normalizeStatus(status) {
            if (!status) return 'pending';
            
            if (status.includes('lunas') || status.includes('paid')) {
                return 'paid';
            } else if (status.includes('overdue') || status.includes('terlambat')) {
                return 'overdue';
            } else {
                return 'pending';
            }
        }

        function showPDFImportConfirmation(parsedData) {
            const currentBillsCount = bills.length;
            
            let confirmMessage = `üìÑ KONFIRMASI IMPORT PDF\n\n`;
            confirmMessage += `üìÅ File: ${parsedData.fileName}\n`;
            confirmMessage += `üìã Total baris: ${parsedData.totalLines}\n`;
            confirmMessage += `‚úÖ Berhasil diparsing: ${parsedData.successCount}\n`;
            confirmMessage += `‚ùå Error: ${parsedData.errorCount}\n\n`;
            
            if (parsedData.errorCount > 0) {
                confirmMessage += `‚ö†Ô∏è Error details:\n`;
                parsedData.errors.slice(0, 2).forEach(error => {
                    confirmMessage += `‚Ä¢ ${error}\n`;
                });
                if (parsedData.errors.length > 2) {
                    confirmMessage += `‚Ä¢ ... dan ${parsedData.errors.length - 2} error lainnya\n`;
                }
                confirmMessage += `\n`;
            }
            
            confirmMessage += `üìä Data saat ini: ${currentBillsCount} tagihan\n`;
            confirmMessage += `üìà Setelah import: ${currentBillsCount + parsedData.successCount} tagihan\n\n`;
            confirmMessage += `üîç Preview teks PDF:\n"${parsedData.extractedText}"\n\n`;
            confirmMessage += `‚úÖ Proses import akan:\n`;
            confirmMessage += `‚Ä¢ Menambahkan ${parsedData.successCount} data baru\n`;
            confirmMessage += `‚Ä¢ OCR parsing dengan AI pattern matching\n`;
            confirmMessage += `‚Ä¢ Tracking lengkap untuk audit\n\n`;
            confirmMessage += `Lanjutkan import?`;
            
            if (confirm(confirmMessage)) {
                performPDFImport(parsedData);
            }
        }

        function performPDFImport(parsedData) {
            const syncTimestamp = new Date().toISOString();
            const syncId = `pdf_import_${Date.now()}`;
            
            // Add parsed bills to system
            parsedData.bills.forEach(bill => {
                // Check for potential duplicates
                const duplicate = bills.find(b => 
                    b.customerName === bill.customerName && 
                    b.customerPhone === bill.customerPhone &&
                    Math.abs(b.amount - bill.amount) < 1000
                );
                
                if (!duplicate) {
                    bill.syncId = syncId;
                    bill.syncTimestamp = syncTimestamp;
                    bills.push(bill);
                }
            });
            
            // Save to localStorage
            localStorage.setItem('bills', JSON.stringify(bills));
            
            // Create import report
            const importReport = {
                syncId: syncId,
                syncDate: syncTimestamp,
                syncBy: currentUser.name,
                sourceType: 'PDF Import',
                sourceFile: parsedData.fileName,
                results: {
                    totalLines: parsedData.totalLines,
                    successfulImports: parsedData.successCount,
                    errors: parsedData.errorCount,
                    errorDetails: parsedData.errors,
                    extractedTextPreview: parsedData.extractedText
                }
            };
            
            // Save import history
            let syncHistory = JSON.parse(localStorage.getItem('syncHistory')) || [];
            syncHistory.push(importReport);
            if (syncHistory.length > 10) syncHistory = syncHistory.slice(-10);
            localStorage.setItem('syncHistory', JSON.stringify(syncHistory));
            
            // Show success message
            const syncDetails = `
                üéâ <strong>IMPORT PDF BERHASIL!</strong><br><br>
                üìä <strong>Hasil Import:</strong><br>
                ‚Ä¢ ‚úÖ ${parsedData.successCount} data berhasil diimport<br>
                ‚Ä¢ ‚ùå ${parsedData.errorCount} data error (dilewati)<br>
                ‚Ä¢ üìÅ File: ${parsedData.fileName}<br>
                ‚Ä¢ üîç OCR Pattern: Smart AI Parsing<br>
                ‚Ä¢ üïí Waktu: ${new Date().toLocaleString('id-ID')}<br>
                ‚Ä¢ üÜî Import ID: ${syncId.substring(0, 20)}...<br><br>
                ${parsedData.errorCount > 0 ? `‚ö†Ô∏è <strong>Catatan:</strong> ${parsedData.errorCount} baris dilewati karena tidak dapat diparsing dengan baik.<br><br>` : ''}
                üí° <strong>Tips:</strong> PDF berhasil diparsing dengan OCR dan AI pattern matching.
            `;
            
            document.getElementById('syncDetails').innerHTML = syncDetails;
            document.getElementById('syncStatus').classList.remove('hidden');
            
            // Hide sync status after 15 seconds
            setTimeout(() => {
                document.getElementById('syncStatus').classList.add('hidden');
            }, 15000);
            
            // Refresh displays
            updateDashboard();
            loadBillsHistory();
            
            showSuccessModal(`üéâ Import PDF berhasil!\n\nüìä ${parsedData.successCount} data berhasil diimport\n‚ùå ${parsedData.errorCount} data error\nüìÅ File: ${parsedData.fileName}\n\nüîç Data berhasil diekstrak dengan OCR dan AI parsing!`);
        }

        function convertExcelToSystemFormat(excelData, fileName) {
            const convertedBills = [];
            let successCount = 0;
            let errorCount = 0;
            const errors = [];
            
            excelData.forEach((row, index) => {
                try {
                    // Map Excel columns to system format (flexible column mapping)
                    const bill = {
                        id: Date.now() + Math.random() + index,
                        customerName: row['Nama Pelanggan'] || row['Nama'] || row['Customer Name'] || row['Name'] || '',
                        customerPhone: (row['No. Telepon'] || row['Telepon'] || row['Phone'] || row['No Telepon'] || '').toString(),
                        customerAddress: row['Alamat'] || row['Address'] || '',
                        amount: parseFloat(row['Jumlah Tagihan'] || row['Amount'] || row['Total'] || 0),
                        dueDate: row['Tanggal Jatuh Tempo'] || row['Due Date'] || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: convertExcelStatus(row['Status'] || 'pending'),
                        description: row['Keterangan'] || row['Description'] || row['Notes'] || `Imported from Excel: ${fileName}`,
                        officer: row['Petugas'] || row['Officer'] || currentUser.name,
                        createdAt: new Date().toISOString(),
                        createdBy: `Excel Import by ${currentUser.name}`,
                        importedAt: new Date().toISOString(),
                        importedBy: currentUser.name,
                        importSource: 'Excel File',
                        importFileName: fileName,
                        excelRowNumber: index + 2 // Excel row number (starting from 2, assuming header in row 1)
                    };
                    
                    // Validate required fields
                    if (!bill.customerName || !bill.customerPhone || !bill.amount || bill.amount <= 0) {
                        throw new Error(`Row ${index + 2}: Missing required data (Name, Phone, or Amount)`);
                    }
                    
                    // Normalize status
                    if (!['pending', 'paid', 'overdue'].includes(bill.status)) {
                        bill.status = 'pending';
                    }
                    
                    convertedBills.push(bill);
                    successCount++;
                    
                } catch (error) {
                    errorCount++;
                    errors.push(`Row ${index + 2}: ${error.message}`);
                }
            });
            
            return {
                bills: convertedBills,
                fileName: fileName,
                totalRows: excelData.length,
                successCount: successCount,
                errorCount: errorCount,
                errors: errors,
                importDate: new Date().toISOString(),
                importBy: currentUser.name
            };
        }

        function convertExcelStatus(statusValue) {
            if (!statusValue) return 'pending';
            
            const status = statusValue.toString().toLowerCase();
            if (status.includes('lunas') || status.includes('paid') || status.includes('bayar')) {
                return 'paid';
            } else if (status.includes('overdue') || status.includes('terlambat')) {
                return 'overdue';
            } else {
                return 'pending';
            }
        }

        function showExcelImportConfirmation(convertedData) {
            const currentBillsCount = bills.length;
            
            let confirmMessage = `üìä KONFIRMASI IMPORT EXCEL\n\n`;
            confirmMessage += `üìÅ File: ${convertedData.fileName}\n`;
            confirmMessage += `üìã Total baris: ${convertedData.totalRows}\n`;
            confirmMessage += `‚úÖ Berhasil dikonversi: ${convertedData.successCount}\n`;
            confirmMessage += `‚ùå Error: ${convertedData.errorCount}\n\n`;
            
            if (convertedData.errorCount > 0) {
                confirmMessage += `‚ö†Ô∏è Error details:\n`;
                convertedData.errors.slice(0, 3).forEach(error => {
                    confirmMessage += `‚Ä¢ ${error}\n`;
                });
                if (convertedData.errors.length > 3) {
                    confirmMessage += `‚Ä¢ ... dan ${convertedData.errors.length - 3} error lainnya\n`;
                }
                confirmMessage += `\n`;
            }
            
            confirmMessage += `üìä Data saat ini: ${currentBillsCount} tagihan\n`;
            confirmMessage += `üìà Setelah import: ${currentBillsCount + convertedData.successCount} tagihan\n\n`;
            confirmMessage += `‚úÖ Proses import akan:\n`;
            confirmMessage += `‚Ä¢ Menambahkan ${convertedData.successCount} data baru\n`;
            confirmMessage += `‚Ä¢ Mencatat sumber import dari Excel\n`;
            confirmMessage += `‚Ä¢ Tracking lengkap untuk audit\n\n`;
            confirmMessage += `Lanjutkan import?`;
            
            if (confirm(confirmMessage)) {
                performExcelImport(convertedData);
            }
        }

        function performExcelImport(convertedData) {
            const syncTimestamp = new Date().toISOString();
            const syncId = `excel_import_${Date.now()}`;
            
            // Add converted bills to system
            convertedData.bills.forEach(bill => {
                // Check for potential duplicates
                const duplicate = bills.find(b => 
                    b.customerName === bill.customerName && 
                    b.customerPhone === bill.customerPhone &&
                    Math.abs(b.amount - bill.amount) < 1000
                );
                
                if (!duplicate) {
                    bill.syncId = syncId;
                    bill.syncTimestamp = syncTimestamp;
                    bills.push(bill);
                }
            });
            
            // Save to localStorage
            localStorage.setItem('bills', JSON.stringify(bills));
            
            // Create import report
            const importReport = {
                syncId: syncId,
                syncDate: syncTimestamp,
                syncBy: currentUser.name,
                sourceType: 'Excel Import',
                sourceFile: convertedData.fileName,
                results: {
                    totalRows: convertedData.totalRows,
                    successfulImports: convertedData.successCount,
                    errors: convertedData.errorCount,
                    errorDetails: convertedData.errors
                }
            };
            
            // Save import history
            let syncHistory = JSON.parse(localStorage.getItem('syncHistory')) || [];
            syncHistory.push(importReport);
            if (syncHistory.length > 10) syncHistory = syncHistory.slice(-10);
            localStorage.setItem('syncHistory', JSON.stringify(syncHistory));
            
            // Show success message
            const syncDetails = `
                üéâ <strong>IMPORT EXCEL BERHASIL!</strong><br><br>
                üìä <strong>Hasil Import:</strong><br>
                ‚Ä¢ ‚úÖ ${convertedData.successCount} data berhasil diimport<br>
                ‚Ä¢ ‚ùå ${convertedData.errorCount} data error (dilewati)<br>
                ‚Ä¢ üìÅ File: ${convertedData.fileName}<br>
                ‚Ä¢ üïí Waktu: ${new Date().toLocaleString('id-ID')}<br>
                ‚Ä¢ üÜî Import ID: ${syncId.substring(0, 20)}...<br><br>
                ${convertedData.errorCount > 0 ? `‚ö†Ô∏è <strong>Catatan:</strong> ${convertedData.errorCount} baris dilewati karena data tidak lengkap atau tidak valid.<br><br>` : ''}
                üí° <strong>Tips:</strong> Data Excel berhasil dikonversi ke format sistem dengan tracking lengkap.
            `;
            
            document.getElementById('syncDetails').innerHTML = syncDetails;
            document.getElementById('syncStatus').classList.remove('hidden');
            
            // Hide sync status after 15 seconds
            setTimeout(() => {
                document.getElementById('syncStatus').classList.add('hidden');
            }, 15000);
            
            // Refresh displays
            updateDashboard();
            loadBillsHistory();
            
            showSuccessModal(`üéâ Import Excel berhasil!\n\nüìä ${convertedData.successCount} data berhasil diimport\n‚ùå ${convertedData.errorCount} data error\nüìÅ File: ${convertedData.fileName}\n\nüí° Data Excel telah dikonversi ke sistem dengan tracking lengkap!`);
        }

        function showImportConfirmation(importData) {
            const currentBillsCount = bills.length;
            const importBillsCount = importData.bills.length;
            const currentUsersCount = users.filter(u => u.id > 2).length;
            const importUsersCount = importData.users.length;
            
            const deviceInfo = importData.deviceInfo || 'Unknown Device';
            const exportDate = new Date(importData.exportDate).toLocaleString('id-ID');
            
            const confirmMessage = `üîÑ KONFIRMASI SINKRONISASI DATA\n\n` +
                `üì• Data yang akan diimport:\n` +
                `‚Ä¢ ${importBillsCount} data tagihan\n` +
                `‚Ä¢ ${importUsersCount} data user\n` +
                `‚Ä¢ Export oleh: ${importData.exportBy}\n` +
                `‚Ä¢ Dari device: ${deviceInfo}\n` +
                `‚Ä¢ Tanggal export: ${exportDate}\n\n` +
                `üìä Data saat ini:\n` +
                `‚Ä¢ ${currentBillsCount} data tagihan\n` +
                `‚Ä¢ ${currentUsersCount} data user\n\n` +
                `‚úÖ Proses sinkronisasi akan:\n` +
                `‚Ä¢ Menggabungkan data (tidak menghapus yang lama)\n` +
                `‚Ä¢ Update data yang sama berdasarkan ID\n` +
                `‚Ä¢ Menambahkan data baru\n` +
                `‚Ä¢ Mencatat history sinkronisasi\n\n` +
                `Lanjutkan import?`;
            
            if (confirm(confirmMessage)) {
                performDataImport(importData);
            }
        }

        function performDataImport(importData) {
            let newBillsCount = 0;
            let newUsersCount = 0;
            let updatedBillsCount = 0;
            let updatedUsersCount = 0;
            let skippedBillsCount = 0;
            
            const syncTimestamp = new Date().toISOString();
            const syncId = `sync_${Date.now()}`;
            
            // Import bills - merge by ID, add new ones
            importData.bills.forEach(importBill => {
                const existingBillIndex = bills.findIndex(b => b.id === importBill.id);
                if (existingBillIndex !== -1) {
                    // Update existing bill with sync info
                    bills[existingBillIndex] = {
                        ...importBill,
                        lastSyncAt: syncTimestamp,
                        lastSyncBy: currentUser.name,
                        lastSyncId: syncId,
                        syncSource: importData.exportBy || 'Unknown'
                    };
                    updatedBillsCount++;
                } else {
                    // Check for potential duplicates by name and phone
                    const duplicate = bills.find(b => 
                        b.customerName === importBill.customerName && 
                        b.customerPhone === importBill.customerPhone &&
                        Math.abs(b.amount - importBill.amount) < 1000 // Allow small amount differences
                    );
                    
                    if (duplicate) {
                        skippedBillsCount++;
                    } else {
                        // Add new bill with sync info
                        bills.push({
                            ...importBill,
                            importedAt: syncTimestamp,
                            importedBy: currentUser.name,
                            syncId: syncId,
                            syncSource: importData.exportBy || 'Unknown'
                        });
                        newBillsCount++;
                    }
                }
            });
            
            // Import users - merge by email, add new ones (except default users)
            importData.users.forEach(importUser => {
                const existingUserIndex = users.findIndex(u => u.email === importUser.email);
                if (existingUserIndex !== -1) {
                    // Update existing user (except default users)
                    if (users[existingUserIndex].id > 2) {
                        users[existingUserIndex] = {
                            ...importUser,
                            id: users[existingUserIndex].id, // Keep original ID
                            lastSyncAt: syncTimestamp
                        };
                        updatedUsersCount++;
                    }
                } else {
                    // Add new user with new ID
                    const newUser = {
                        ...importUser,
                        id: Math.max(...users.map(u => u.id)) + 1,
                        importedAt: syncTimestamp,
                        importedBy: currentUser.name
                    };
                    users.push(newUser);
                    newUsersCount++;
                }
            });
            
            // Save to localStorage
            localStorage.setItem('bills', JSON.stringify(bills));
            localStorage.setItem('users', JSON.stringify(users));
            
            // Create detailed sync report
            const syncReport = {
                syncId: syncId,
                syncDate: syncTimestamp,
                syncBy: currentUser.name,
                sourceDevice: importData.deviceInfo || 'Unknown Device',
                sourceUser: importData.exportBy,
                sourceExportDate: importData.exportDate,
                results: {
                    newBills: newBillsCount,
                    updatedBills: updatedBillsCount,
                    skippedBills: skippedBillsCount,
                    newUsers: newUsersCount,
                    updatedUsers: updatedUsersCount,
                    totalProcessed: newBillsCount + updatedBillsCount + newUsersCount + updatedUsersCount
                }
            };
            
            // Save sync history
            let syncHistory = JSON.parse(localStorage.getItem('syncHistory')) || [];
            syncHistory.push(syncReport);
            if (syncHistory.length > 10) syncHistory = syncHistory.slice(-10); // Keep last 10 syncs
            localStorage.setItem('syncHistory', JSON.stringify(syncHistory));
            
            // Show detailed sync status
            const syncDetails = `
                üéâ <strong>SINKRONISASI BERHASIL!</strong><br><br>
                üìä <strong>Hasil Import:</strong><br>
                ‚Ä¢ ‚úÖ ${newBillsCount} tagihan baru ditambahkan<br>
                ‚Ä¢ üîÑ ${updatedBillsCount} tagihan diperbarui<br>
                ‚Ä¢ ‚ö†Ô∏è ${skippedBillsCount} tagihan duplikat dilewati<br>
                ‚Ä¢ üë§ ${newUsersCount} user baru ditambahkan<br>
                ‚Ä¢ üîÑ ${updatedUsersCount} user diperbarui<br><br>
                üì± <strong>Sumber:</strong> ${importData.exportBy} (${importData.deviceInfo || 'Unknown Device'})<br>
                üïí <strong>Waktu:</strong> ${new Date().toLocaleString('id-ID')}<br>
                üÜî <strong>Sync ID:</strong> ${syncId.substring(0, 12)}...
            `;
            
            document.getElementById('syncDetails').innerHTML = syncDetails;
            document.getElementById('syncStatus').classList.remove('hidden');
            
            // Hide sync status after 15 seconds
            setTimeout(() => {
                document.getElementById('syncStatus').classList.add('hidden');
            }, 15000);
            
            // Refresh all data displays
            updateDashboard();
            loadBillsHistory();
            if (currentUser.role === 'admin') {
                loadUsersList();
            }
            
            const totalSynced = newBillsCount + updatedBillsCount + newUsersCount + updatedUsersCount;
            showSuccessModal(`üéâ Sinkronisasi berhasil!\n\nüìä Total ${totalSynced} data berhasil disinkronisasi\n‚úÖ ${newBillsCount + newUsersCount} data baru\nüîÑ ${updatedBillsCount + updatedUsersCount} data diperbarui\n‚ö†Ô∏è ${skippedBillsCount} duplikat dilewati\n\nüîç Lihat detail di panel Sync Status`);
        }

        document.getElementById('exportPDF').addEventListener('click', function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(16);
            doc.text('LAPORAN DATA TAGIHAN', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text(`Tanggal Export: ${new Date().toLocaleDateString('id-ID')}`, 105, 30, { align: 'center' });
            
            // Table headers
            const headers = ['No', 'Nama', 'Telepon', 'Alamat', 'Jumlah', 'Status', 'Petugas'];
            const colWidths = [15, 30, 25, 25, 25, 20, 25];
            let xPos = 20;
            let yPos = 50;
            
            // Draw header
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            headers.forEach((header, i) => {
                doc.text(header, xPos, yPos);
                xPos += colWidths[i];
            });
            
            // Draw line under header
            doc.line(20, yPos + 2, 190, yPos + 2);
            yPos += 10;
            
            // Draw data rows
            doc.setFont(undefined, 'normal');
            bills.forEach((bill, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                    
                    // Redraw header on new page
                    doc.setFont(undefined, 'bold');
                    xPos = 20;
                    headers.forEach((header, i) => {
                        doc.text(header, xPos, yPos);
                        xPos += colWidths[i];
                    });
                    doc.line(20, yPos + 2, 190, yPos + 2);
                    yPos += 10;
                    doc.setFont(undefined, 'normal');
                }
                
                xPos = 20;
                const rowData = [
                    (index + 1).toString(),
                    bill.customerName.substring(0, 12),
                    bill.customerPhone,
                    bill.customerAddress.substring(0, 10),
                    `Rp ${(bill.amount / 1000).toFixed(0)}K`,
                    getStatusText(bill.status),
                    (bill.officer || '-').substring(0, 10)
                ];
                
                rowData.forEach((data, i) => {
                    doc.text(data, xPos, yPos);
                    xPos += colWidths[i];
                });
                
                yPos += 8;
            });
            
            // Summary
            yPos += 10;
            doc.line(20, yPos, 190, yPos);
            yPos += 10;
            doc.setFont(undefined, 'bold');
            doc.text(`Total Data: ${bills.length}`, 20, yPos);
            doc.text(`Total Nilai: Rp ${bills.reduce((sum, bill) => sum + bill.amount, 0).toLocaleString('id-ID')}`, 20, yPos + 10);
            
            doc.save(`laporan-tagihan-${new Date().toISOString().split('T')[0]}.pdf`);
        });

        // User Management Functions
        function loadUsersList() {
            const usersList = document.getElementById('usersList');
            if (users.length === 0) {
                usersList.innerHTML = '<p class="text-gray-500 text-center py-8">Belum ada data user</p>';
            } else {
                usersList.innerHTML = users.map(user => `
                    <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800">${user.name}</h4>
                                <p class="text-sm text-gray-600">${user.email}</p>
                                <div class="flex flex-wrap gap-2 mt-1">
                                    <span class="inline-block px-2 py-1 text-xs rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800'}">${user.role.toUpperCase()}</span>
                                    ${user.importedAt ? '<span class="inline-block px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">SYNCED</span>' : ''}
                                </div>
                                ${user.lastSyncAt ? `<p class="text-xs text-gray-500 mt-1">Last sync: ${new Date(user.lastSyncAt).toLocaleDateString('id-ID')}</p>` : ''}
                            </div>
                            <div class="flex space-x-2 w-full sm:w-auto">
                                ${user.id > 2 ? `<button onclick="deleteUser(${user.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm transition-colors flex-1 sm:flex-none">
                                    <i class="fas fa-trash mr-1"></i>Hapus
                                </button>` : '<span class="text-xs text-gray-500 px-3 py-1">Default User</span>'}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Add User Form Handlers
        document.getElementById('addUserBtn').addEventListener('click', function() {
            document.getElementById('addUserForm').classList.remove('hidden');
        });

        document.getElementById('cancelAddUser').addEventListener('click', function() {
            document.getElementById('addUserForm').classList.add('hidden');
            document.getElementById('userForm').reset();
        });

        document.getElementById('userForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (users.find(u => u.email === email)) {
                showSuccessModal('Email sudah terdaftar!');
                return;
            }
            
            const newUser = {
                id: Math.max(...users.map(u => u.id)) + 1,
                name,
                email,
                password,
                role,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            showSuccessModal('User berhasil ditambahkan!');
            loadUsersList();
            document.getElementById('addUserForm').classList.add('hidden');
            this.reset();
        });

        function deleteUser(id) {
            if (id <= 2) {
                showSuccessModal('User default tidak dapat dihapus!');
                return;
            }
            
            users = users.filter(u => u.id !== id);
            localStorage.setItem('users', JSON.stringify(users));
            showSuccessModal('User berhasil dihapus!');
            loadUsersList();
        }

        // Generate Data Functions
        document.getElementById('generateDataBtn').addEventListener('click', function() {
            const count = parseInt(document.getElementById('generateCount').value);
            const includePending = document.getElementById('genPending').checked;
            const includePaid = document.getElementById('genPaid').checked;
            const includeOverdue = document.getElementById('genOverdue').checked;
            
            if (!includePending && !includePaid && !includeOverdue) {
                showSuccessModal('Pilih minimal satu status untuk generate data!');
                return;
            }
            
            generateDummyData(count, { includePending, includePaid, includeOverdue });
        });

        function generateDummyData(count, options) {
            const progress = document.getElementById('generateProgress');
            const progressBar = document.getElementById('progressBar');
            
            progress.classList.remove('hidden');
            
            const names = [
                'Ahmad Wijaya', 'Siti Nurhaliza', 'Budi Santoso', 'Dewi Sartika', 'Eko Prasetyo',
                'Fitri Handayani', 'Gunawan Susanto', 'Hesti Purnamasari', 'Indra Kusuma', 'Joko Widodo',
                'Kartika Sari', 'Lukman Hakim', 'Maya Sari', 'Nanda Pratama', 'Oki Setiana',
                'Putri Maharani', 'Qori Sandioriva', 'Rini Soemarno', 'Sari Nila', 'Tono Suratman'
            ];
            
            const addresses = [
                'Jl. Merdeka No. 123, Jakarta', 'Jl. Sudirman No. 456, Bandung', 'Jl. Thamrin No. 789, Surabaya',
                'Jl. Gatot Subroto No. 321, Medan', 'Jl. Ahmad Yani No. 654, Semarang', 'Jl. Diponegoro No. 987, Yogyakarta',
                'Jl. Veteran No. 147, Malang', 'Jl. Pahlawan No. 258, Denpasar', 'Jl. Pemuda No. 369, Palembang'
            ];

            const officers = [
                'Mario Haulussy', 'Macho Haulussy', 'Ryan Pattiwael', 'Stevy Wuarlela',
                'Stevian Lauluw', 'Gilberd', 'Glen Tansora', 'Glen Ohman'
            ];
            
            const statuses = [];
            if (options.includePending) statuses.push('pending');
            if (options.includePaid) statuses.push('paid');
            if (options.includeOverdue) statuses.push('overdue');
            
            let generated = 0;
            const interval = setInterval(() => {
                if (generated >= count) {
                    clearInterval(interval);
                    progress.classList.add('hidden');
                    progressBar.style.width = '0%';
                    showSuccessModal(`Berhasil generate ${count} data tagihan!`);
                    updateDashboard();
                    loadBillsHistory();
                    return;
                }
                
                // Generate batch of 5 data at once
                const batchSize = Math.min(5, count - generated);
                for (let i = 0; i < batchSize; i++) {
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    const randomAddress = addresses[Math.floor(Math.random() * addresses.length)];
                    const randomOfficer = officers[Math.floor(Math.random() * officers.length)];
                    const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                    const randomAmount = Math.floor(Math.random() * 5000000) + 100000; // 100K - 5M
                    
                    const bill = {
                        id: Date.now() + Math.random(),
                        customerName: randomName,
                        customerPhone: `08${Math.floor(Math.random() * 1000000000).toString().padStart(9, '0')}`,
                        customerAddress: randomAddress,
                        amount: randomAmount,
                        dueDate: new Date(Date.now() + Math.random() * 60 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                        status: randomStatus,
                        description: `Tagihan ${randomStatus} - Generated Data`,
                        officer: randomOfficer,
                        createdAt: new Date(Date.now() - Math.random() * 30 * 24 * 60 * 60 * 1000).toISOString(),
                        createdBy: 'System Generator'
                    };
                    
                    bills.push(bill);
                    generated++;
                }
                
                localStorage.setItem('bills', JSON.stringify(bills));
                
                const progressPercent = (generated / count) * 100;
                progressBar.style.width = `${progressPercent}%`;
            }, 100);
        }

        // Utility functions
        function getStatusColor(status) {
            switch (status) {
                case 'paid': return 'bg-green-100 text-green-800';
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'overdue': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'paid': return 'Lunas';
                case 'pending': return 'Pending';
                case 'overdue': return 'Overdue';
                default: return 'Unknown';
            }
        }

        function showMessage(message, type) {
            // Simple message display - you can enhance this
            if (type === 'error') {
                document.getElementById('successMessage').textContent = message;
                document.getElementById('successModal').classList.remove('hidden');
            }
        }

        function showSuccessModal(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successModal').classList.remove('hidden');
        }

        document.getElementById('closeSuccessModal').addEventListener('click', function() {
            document.getElementById('successModal').classList.add('hidden');
        });

        // Initialize the application
        initApp();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'994093e7657e6bd6',t:'MTc2MTM4MzM5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
